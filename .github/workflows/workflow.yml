name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: Install dependencies
      working-directory: ${{ github.workspace }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: 
        python -m PyInstaller helper.spec

    - name: Create Tag
      id: create_tag
      run: |
        $tagName = "v$(Get-Date -Format 'yyyy.MM.dd.HHmm')"
        "TAG_NAME=$tagName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        Write-Host "Created tag: $tagName"
        Write-Host "Tag name will be: $tagName"

    - name: Verify Tag Name
      run: |
        Write-Host "TAG_NAME environment variable: $env:TAG_NAME"
        if (-not $env:TAG_NAME) {
          Write-Error "TAG_NAME is not set!"
          exit 1
        }

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        files: |
          dist/POE_Helper.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}