name: Build and Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: Install dependencies
      working-directory: ${{ github.workspace }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: 
        python -m PyInstaller helper.spec

    - name: Create Tag
      id: create_tag
      run: |
        # Get the latest git tag
        $latestTagOutput = git describe --tags --abbrev=0 2>&1
        if ($LASTEXITCODE -eq 0 -and $latestTagOutput) {
          $latestTag = $latestTagOutput.Trim()
          Write-Host "Latest git tag: $latestTag"
        } else {
          $latestTag = ""
          Write-Host "No existing tags found, starting fresh"
        }
        
        # Generate timestamp-based tag name
        $timestampTag = "v$(Get-Date -Format 'yyyy.MM.dd.HHmm')"
        
        # Prepend git tag if it exists
        if ($latestTag) {
          $tagName = "$latestTag-$timestampTag"
        } else {
          $tagName = $timestampTag
        }
        
        "TAG_NAME=$tagName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        Write-Host "Created tag: $tagName"
        Write-Host "Tag name will be: $tagName"

    - name: Verify Tag Name
      run: |
        Write-Host "TAG_NAME environment variable: $env:TAG_NAME"
        if (-not $env:TAG_NAME) {
          Write-Error "TAG_NAME is not set!"
          exit 1
        }

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        files: |
          dist/POE_Helper.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}